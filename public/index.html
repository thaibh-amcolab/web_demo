<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dev.to Tour Guide</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body, html {
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #site-container {
            position: relative;
            top: 0;
            left: 0;
            width: 50%;
            height: 500px;
            z-index: 1;
        }
        #site-iframe {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            border: none;
        }
        #idol-overlay {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 300px;
            z-index: 1000;
            pointer-events: none;
        }
        #idol-dialogue {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: white;
            border: 2px solid #4285F4;
            border-radius: 10px;
            padding: 15px;
            max-width: 300px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1001;
            display: none;
        }
        .highlight {
            border: 3px solid #4285F4 !important;
            box-shadow: 0 0 15px rgba(66, 133, 244, 0.7) !important;
        }
        #tour-controls {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1002;
            background-color: white;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="tour-controls">
        <button id="start-tour">Start Tour</button>
    </div>
    <div id="site-container">
        <iframe id="site-iframe" frameborder="0"></iframe>

    </div>
    <div id="idol-overlay"></div>
    <div id="idol-dialogue"></div>

    <script>
        class IdolRenderer {
            constructor(container) {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
                this.renderer = new THREE.WebGLRenderer({ alpha: true });
                
                this.renderer.setSize(300, 300);
                container.appendChild(this.renderer.domElement);
                
                const geometry = new THREE.BoxGeometry(1, 1, 1);
                const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
                this.idol = new THREE.Mesh(geometry, material);
                this.scene.add(this.idol);
                
                this.camera.position.z = 5;
                this.animate();
            }
            
            animate() {
                requestAnimationFrame(() => this.animate());
                this.idol.rotation.x += 0.01;
                this.idol.rotation.y += 0.01;
                this.renderer.render(this.scene, this.camera);
            }
        }

        class CrossOriginIframeManager {
            constructor(iframe, dialogueElement) {
                this.iframe = iframe;
                this.dialogueElement = dialogueElement;
                this.setupMessageListener();
            }

            setupMessageListener() {
                window.addEventListener('message', (event) => {
                    this.processMessage(event.data);
                });
            }

            sendMessage(message) {
                this.iframe.contentWindow.postMessage(message, '*');
            }

            processMessage(data) {
                switch(data.type) {
                    case 'elementInfo':
                        this.handleElementInfo(data);
                        break;
                }
            }

            speak(message) {
                this.dialogueElement.textContent = message;
                this.dialogueElement.style.display = 'block';
                setTimeout(() => {
                    this.dialogueElement.style.display = 'none';
                }, 3000);
            }

            findElement(selector) {
                this.sendMessage({
                    type: 'findElement',
                    selector: selector
                });
            }

            clickElement(selector) {
                this.sendMessage({
                    type: 'clickElement',
                    selector: selector
                });
            }

            handleElementInfo(data) {
                if (data.selector) {
                    console.log('Element found:', data);
                    this.speak(`I found the ${data.selector} element!`);
                }
            }

            scrollDown(pixels = 3000) {
                this.sendMessage({
                    type: 'scrollDown',
                    pixels: pixels
                });
            }


            injectInteractionScript() {
                const script = `
                window.addEventListener('DOMContentLoaded', () => {
                    // Rewrite all links to point directly to the original site
                    const links = document.querySelectorAll('a[href]');
                    links.forEach(link => {
                        const url = new URL(link.href);
                        if (url.origin === window.location.origin) {
                            link.href = url.searchParams.get('url') || link.href;
                        }
                    });
                });


                window.addEventListener('message', (event) => {
                    if (event.data.type === 'findElement') {
                        const element = document.querySelector(event.data.selector);
                        if (element) {
                            const rect = element.getBoundingClientRect();
                            element.style.border = '3px solid blue';
                            window.parent.postMessage({
                                type: 'elementInfo',
                                selector: event.data.selector,
                                bounds: {
                                    top: rect.top,
                                    left: rect.left,
                                    width: rect.width,
                                    height: rect.height
                                }
                            }, '*');
                        }
                    }

                    if (event.data.type === 'clickElement') {
                        const element = document.querySelector(event.data.selector);
                        if (element) {
                            element.click();
                        }
                    }

                    if (event.data.type === 'scrollDown') {
                        window.scrollBy(0, event.data.pixels || 300);
                    }
                });
                `;

                this.iframe.contentWindow.postMessage({
                    type: 'injectScript',
                    script: script
                }, '*');
            }
        }

        class WebsiteInteractionManager {
            constructor() {
                this.proxyUrl = 'http://localhost:3001/proxy';
            }

            // Fetch website content via proxy
            async fetchWebsiteContent(url) {
                try {
                    const response = await fetch(`${this.proxyUrl}?url=${encodeURIComponent(url)}`);
                    return await response.text();
                } catch (error) {
                    console.error('Failed to fetch website content:', error);
                    return null;
                }
            }

            // Parse and extract specific elements
            extractElements(htmlContent, selectors) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');
                
                return selectors.map(selector => {
                    const element = doc.querySelector(selector);
                    return element ? {
                        selector: selector,
                        text: element.textContent,
                        href: element.getAttribute('href')
                    } : null;
                }).filter(Boolean);
            }

            // Simulate interactions
            simulateInteraction(element) {
                // This would typically be implemented on the client-side
                console.log('Simulating interaction with:', element);
            }
        }

        class DevToTourGuide {
            constructor(iframeManager) {
                this.iframeManager = iframeManager;
                this.tourSteps = [
                    {
                        selector: 'a[href="/signup"]',
                        dialogue: "Let's create an account on Dev.to! Click on the 'Create account' link."
                    }
                ];
                this.currentStep = 0;
            }

            startTour() {
                this.iframeManager.injectInteractionScript();
                this.executeCurrentStep();
            }

            executeCurrentStep() {
                if (this.currentStep < this.tourSteps.length) {
                    const step = this.tourSteps[this.currentStep];
                    this.iframeManager.speak(step.dialogue);
                    this.iframeManager.findElement(step.selector);
                    
                    // Optional: Click the element
                    setTimeout(() => {
                        this.iframeManager.clickElement(step.selector);
                    }, 3000);

                    this.currentStep++;
                }
            }
        }

        function setupIframe() {
            const iframe = document.getElementById('site-iframe');
            const iframeContainer = document.getElementById('site-container');

            // Set iframe width to twice the container width
            iframe.style.width = `${iframeContainer.offsetWidth * 2}px`;

            // Shift iframe to show middle section (1/3 portion)
            const shiftAmount = (iframe.offsetWidth - iframeContainer.offsetWidth) / 2;
            iframe.style.left = `-${shiftAmount}px`;
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            setupIframe
            const iframe = document.getElementById('site-iframe');
            const idolContainer = document.getElementById('idol-overlay');
            const dialogueElement = document.getElementById('idol-dialogue');
            const startTourButton = document.getElementById('start-tour');

            // Initialize Three.js Idol
            const idolRenderer = new IdolRenderer(idolContainer);

            // Setup Iframe Manager
            const iframeManager = new CrossOriginIframeManager(iframe, dialogueElement);
            // Setup Tour Guide
            const tourGuide = new DevToTourGuide(iframeManager);

            // Load Dev.to
            iframe.src = `http://localhost:3001/proxy?url=${encodeURIComponent('https://www.oshimaya.jp/')}`;

            // Start Tour on Button Click
            startTourButton.addEventListener('click', () => {
                tourGuide.startTour();
            });
        });
    </script>
</body>
</html>